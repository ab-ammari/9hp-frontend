<div id="container" class="stratigraphic-test-page">
  <main>
    <section>
      <ion-row>
        <ion-col size="12">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Contrôle stratigraphique</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item>
                  <ion-label>Type de paradoxe</ion-label>
                  <ion-select [(ngModel)]="selectedParadoxType" placeholder="Sélectionner">
                    <ion-select-option *ngFor="let type of paradoxTypes" [value]="type.id">
                      {{ type.name }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-list>

              <ion-button expand="block" class="ion-margin-top" (click)="findParadoxes()" [disabled]="isSearching">
                <ion-icon name="search-outline" slot="start"></ion-icon>
                {{ isSearching ? 'Recherche en cours...' : 'Rechercher les paradoxes' }}
              </ion-button>

            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
      <div *ngIf="!isSearching">
        <ion-card *ngIf="hasSearched && paradoxResults.length === 0 && !isSearching" class="success-message">
          <ion-card-content class="ion-text-center">
            <ion-icon name="checkmark-circle" color="success" style="font-size: 28px;"></ion-icon>
            <h3>Tout semble cohérent dans les relations stratigraphiques, Bravo!</h3>
          </ion-card-content>
        </ion-card>

        <div *ngFor="let entry of groupedParadoxes | keyvalue:paradoxKeyValueComparator" class="paradox-group">
          <ng-container *ngIf="entry.value.length > 0">
            <div class="group-header" (click)="toggleGroupExpand(entry.key)">
            <ion-item lines="none" detail="false" button>
              <ion-icon name="chevron-down" *ngIf="expandedGroups[entry.key]"></ion-icon>
              <ion-icon name="chevron-forward" *ngIf="!expandedGroups[entry.key]"></ion-icon>
              <ion-label>
                <h2>{{ formatParadoxType(entry.key) }} ({{ entry.value.length }})</h2>
              </ion-label>
            </ion-item>
          </div>

          <div class="group-content" [hidden]="!expandedGroups[entry.key]">
            <div *ngFor="let paradox of entry.value; let i = index" class="paradox-item">

              <ng-container *ngIf="isCycleParadox(paradox)">
                <ion-item button detail (click)="toggleCycleExpand(entry.key, i, $event)" class="cycle-header">
                  <ion-icon slot="start" [name]="isCycleExpanded(entry.key, i) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
                  <ion-label class="ion-text-wrap">
                    <div class="cycle-description">
                      <span>Cycle détecté ( <span class="relation-count">{{ getInvolvedRelationsCount(paradox) }} relations impliquées</span> ):</span>
                      <div class="cycle-entities">
                        <ng-container *ngFor="let nodeUUID of paradox.cycleNodesUUIDs; let i = index">
                            <ng-container *ngIf="getEntityTable(nodeUUID) as table">
                              <app-castor-tag-display
                                [description]="{table: table, uuid: nodeUUID}"
                                [infoBulle]="true"
                              ></app-castor-tag-display>
                            </ng-container>
                            <!-- Flèche -->
                            <span class="arrow">&#10230;</span>
                        </ng-container>

                        <ng-container
                          *ngIf="paradox.cycleNodesUUIDs?.length > 0 &&
                          getEntityTable(paradox.cycleNodesUUIDs[0]) as firstTable">
                          <app-castor-tag-display
                            [description]="{table: firstTable, uuid: paradox.cycleNodesUUIDs[0]}"
                            [infoBulle]="true"
                          ></app-castor-tag-display>
                        </ng-container>
                      </div>
                    </div>
                  </ion-label>
                </ion-item>

                <div *ngIf="isCycleExpanded(entry.key, i)" class="cycle-details">
                  <table class="table strati-relation-table">
                    <tbody>
                    <ng-container *ngFor="let relation of paradox.allRelations; let j = index">
                      <tr [attr.data-relation-id]="relation.stratigraphie_uuid">
                        <td class="relation-content">
                          <ng-container *ngIf="!relation.is_contemporain">
                            <!-- Entité postérieure -->
                            <app-castor-tag-display *ngIf="relation.us_posterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_posterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>

                            <span class="relation-type"><strong>sous</strong></span>

                            <!-- Entité antérieure -->
                            <app-castor-tag-display *ngIf="relation.us_anterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_anterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                          </ng-container>
                        </td>

                        <!-- Actions -->
                        <td class="text-end align-middle action-column">
                          <ion-icon name="eye-outline"
                                    class="preview-icon"
                                    title="Voir l'impact de la suppression"
                                    (click)="$event.stopPropagation(); simulateRelationRemoval(relation, $event)">
                          </ion-icon>
                          <ion-icon *ngIf="canDeleteRelation(relation)"
                                    name="close-outline"
                                    class="delete-icon"
                                    title="Supprimer cette relation"
                                    (click)="$event.stopPropagation(); deleteRelation(relation, $event)">
                          </ion-icon>
                        </td>
                      </tr>
                    </ng-container>
                    </tbody>
                  </table>
                </div>
              </ng-container>

              <!-- Affichage standard pour les autres types de paradoxes -->
              <ng-container *ngIf="!isCycleParadox(paradox) ">
                <ion-item button detail (click)="toggleCycleExpand(entry.key, i, $event)" class="cycle-header">
                  <ion-icon slot="start" [name]="isCycleExpanded(entry.key, i) ? 'chevron-down' : 'chevron-forward'"></ion-icon>
                  <ion-label class="ion-text-wrap">
                    <!-- Affichage du message court si disponible, sinon message normal -->
                    <p class="paradox-summary" [innerHTML]="paradox.shortMessage || getShortMessage(paradox)"></p>
                    <p class="relation-count">{{ getInvolvedRelationsCount(paradox) }} relations impliquées</p>
                  </ion-label>
                </ion-item>

                <!-- Détails du paradoxe standard (visibles/cachés selon état) -->
                <div *ngIf="isCycleExpanded(entry.key, i)" class="standard-details">
                  <!-- Message détaillé -->
                  <div class="detailed-message">
                    <p>{{ paradox.message }}</p>
                  </div>

                  <!-- Liste des relations impliquées -->
                  <table class="table strati-relation-table">
                    <tbody>
                    <ng-container *ngFor="let relation of paradox.relations; let j = index">
                      <tr [attr.data-relation-id]="relation.stratigraphie_uuid">
                        <!-- Colonne Type -->

                        <td class="relation-content">
                          <!-- Pour les relations non contemporaines -->
                          <ng-container *ngIf="!relation.is_contemporain">
                            <!-- Entité postérieure -->
                            <app-castor-tag-display *ngIf="relation.us_posterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_posterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>


                            <span class="relation-type"><strong>sous</strong></span>

                            <!-- Entité antérieure -->
                            <app-castor-tag-display *ngIf="relation.us_anterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_anterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                          </ng-container>

                          <!-- Pour les relations contemporaines -->
                          <ng-container *ngIf="relation.is_contemporain">
                            <!-- Première entité -->
                            <app-castor-tag-display *ngIf="relation.us_posterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_posterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_posterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>

                            <!-- Texte "contemporain à" -->
                            <span class="relation-type">contemporain à</span>

                            <!-- Seconde entité -->
                            <app-castor-tag-display *ngIf="relation.us_anterieur"
                                                    [description]="{table: ApiDbTable.us, uuid: relation.us_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                            <app-castor-tag-display *ngIf="relation.fait_anterieur"
                                                    [description]="{table: ApiDbTable.fait, uuid: relation.fait_anterieur}"
                                                    [infoBulle]="true"></app-castor-tag-display>
                          </ng-container>
                        </td>

                        <!-- Colonne Actions -->
                        <td class="text-end align-middle action-column">
                          <ion-icon name="eye-outline"
                                    class="preview-icon"
                                    title="Voir l'impact de la suppression"
                                    (click)="$event.stopPropagation(); simulateRelationRemoval(relation, $event)">
                          </ion-icon>
                          <ion-icon name="close-outline"
                                    class="delete-icon"
                                    title="Supprimer cette relation"
                                    (click)="$event.stopPropagation(); deleteRelation(relation, $event)">
                          </ion-icon>
                        </td>
                      </tr>
                    </ng-container>
                    </tbody>
                  </table>
                </div>
              </ng-container>
            </div>
          </div>
          </ng-container>
        </div>
      </div>
    </section>

    <div *ngIf="isDeletingRelation" class="deletion-overlay">
      <ion-spinner name="dots"></ion-spinner>
      <p>Suppression en cours...</p>
    </div>
  </main>
</div>

<div *ngIf="simulationResults.isActive" class="impact-preview-overlay">
  <div class="impact-preview-container">
    <div class="impact-preview-header">
      <h2>Impact de la suppression</h2>
      <ion-icon name="close-outline" class="close-icon" (click)="closeImpactPreview()"></ion-icon>
    </div>

    <div class="impact-preview-content">
      <p class="impact-relation">Relation à supprimer:
        <strong>{{ formatRelationAsText(simulationResults.removedRelation) }}</strong>
      </p>

      <div class="impact-stats">
        <div class="impact-stat-item"
             [class.positive]="simulationResults.removedParadoxes > 0"
             [class.negative]="simulationResults.addedParadoxes > 0"
             [class.neutral]="simulationResults.removedParadoxes === 0 && simulationResults.addedParadoxes === 0">
          <h3>Paradoxes</h3>
          <div *ngIf="simulationResults.removedParadoxes > 0" class="positive-impact">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <span>{{ simulationResults.removedParadoxes }} paradoxe(s) résolu(s)</span>
          </div>
          <div *ngIf="simulationResults.addedParadoxes > 0" class="negative-impact">
            <ion-icon name="alert-circle-outline"></ion-icon>
            <span>{{ simulationResults.addedParadoxes }} nouveau(x) paradoxe(s) créé(s)</span>
          </div>
          <div *ngIf="simulationResults.removedParadoxes === 0 && simulationResults.addedParadoxes === 0" class="neutral-impact">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>Aucun changement dans le nombre total de paradoxes</span>
          </div>
        </div>

        <div class="impact-stat-item"
             [class.positive]="simulationResults.removedCycles > 0"
             [class.negative]="simulationResults.addedCycles > 0"
             [class.neutral]="simulationResults.removedCycles === 0 && simulationResults.addedCycles === 0">
          <h3>Cycles</h3>
          <div *ngIf="simulationResults.removedCycles > 0" class="positive-impact">
            <ion-icon name="checkmark-circle-outline"></ion-icon>
            <span>{{ simulationResults.removedCycles }} cycle(s) résolu(s)</span>
          </div>
          <div *ngIf="simulationResults.addedCycles > 0" class="negative-impact">
            <ion-icon name="alert-circle-outline"></ion-icon>
            <span>{{ simulationResults.addedCycles }} nouveau(x) cycle(s) créé(s)</span>
          </div>
          <div *ngIf="simulationResults.removedCycles === 0 && simulationResults.addedCycles === 0" class="neutral-impact">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>Aucun changement dans le nombre de cycles</span>
          </div>
        </div>
      </div>

      <div class="impact-summary"
           [class.positive-summary]="simulationResults.removedParadoxes > simulationResults.addedParadoxes"
           [class.negative-summary]="simulationResults.addedParadoxes > simulationResults.removedParadoxes"
           [class.neutral-summary]="simulationResults.removedParadoxes === simulationResults.addedParadoxes">
        <h3>Résumé de l'impact</h3>
        <p *ngIf="simulationResults.removedParadoxes > simulationResults.addedParadoxes">
          <ion-icon name="thumbs-up-outline"></ion-icon>
          La suppression de cette relation a un impact positif sur le projet.
        </p>
        <p *ngIf="simulationResults.addedParadoxes > simulationResults.removedParadoxes">
          <ion-icon name="thumbs-down-outline"></ion-icon>
          La suppression de cette relation a un impact négatif sur le projet.
        </p>
        <p *ngIf="simulationResults.removedParadoxes === simulationResults.addedParadoxes">
          <ion-icon name="hand-right-outline"></ion-icon>
          La suppression de cette relation n'a pas d'impact significatif sur le projet.
        </p>
      </div>

      <div class="impact-actions">
        <button (click)="confirmRemovalAfterImpactPreview()" class="confirm-button">
          Confirmer la suppression
        </button>
        <button (click)="closeImpactPreview()" class="cancel-button">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>
