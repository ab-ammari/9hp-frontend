<div id="container" class="stratigraphic-diagram-page">
  <!-- Zone de visualisation du diagramme - plein écran -->
  <main class="diagram-fullscreen">
    <!-- Diagramme -->
    <section class="diagram-display" [hidden]="!currentMermaidCode">
      <div
        #diagramContainer
        id="diagram-container"
        class="diagram-container">
        <!-- Le diagramme Mermaid sera rendu ici -->
      </div>

      <!-- Contrôles de zoom intégrés + Légende -->
      <div class="zoom-controls-overlay">
        <!-- Boutons de zoom existants -->
        <div class="zoom-buttons">
          <ion-button size="small" fill="solid" (click)="zoomIn()" color="light">
            <ion-icon name="add-circle-outline"></ion-icon>
          </ion-button>
          <ion-button size="small" fill="solid" (click)="zoomOut()" color="light">
            <ion-icon name="remove-circle-outline"></ion-icon>
          </ion-button>
          <ion-button size="small" fill="solid" (click)="centerDiagram()" color="light">
            <ion-icon name="locate-outline"></ion-icon>
          </ion-button>
          <ion-button size="small" fill="solid" (click)="toggleFullscreen()" color="light">
            <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'"></ion-icon>
          </ion-button>
        </div>

        <!-- Séparateur -->
        <div class="controls-separator"></div>

        <!-- Toggle Légende -->
        <ion-button 
          size="small" 
          [fill]="showLegend ? 'solid' : 'outline'" 
          (click)="toggleLegend()" 
          [color]="showLegend ? 'primary' : 'medium'"
          class="legend-toggle-btn">
          <ion-icon name="information-circle-outline"></ion-icon>
        </ion-button>
      </div>

      <!-- Légende compacte (positionnée en bas à gauche) -->
      <div class="diagram-legend" 
          *ngIf="currentMermaidCode" 
          [class.legend-visible]="showLegend"
          [class.legend-hidden]="!showLegend">
        <div class="legend-header">
          <span class="legend-title">Légende</span>
          <ion-button fill="clear" size="small" (click)="toggleLegend()" class="legend-close">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        <div class="legend-items">
          <div class="legend-item">
            <div class="legend-color" [style.background]="styleConfig.usBackground" 
                [style.borderColor]="styleConfig.usStroke"></div>
            <span>US</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" [style.background]="styleConfig.faitBackground" 
                [style.borderColor]="styleConfig.faitStroke"></div>
            <span>Fait</span>
          </div>
          <div class="legend-item">
            <div class="legend-color legend-dashed" 
                [style.background]="styleConfig.contemporaryGroupBackground"
                [style.borderColor]="styleConfig.contemporaryGroupStroke"></div>
            <span>Contemporain</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Message si pas de diagramme -->
    <section *ngIf="!currentMermaidCode && !isGenerating" class="empty-state">
      <ion-icon name="git-network-outline" class="empty-icon"></ion-icon>
      <h2>Aucun diagramme généré</h2>
      <p>Cliquez sur le bouton ci-dessous pour générer votre diagramme</p>
      
      <ion-button 
        (click)="generateDiagram()" 
        color="primary"
        class="ion-margin-top">
        <ion-icon name="git-network-outline" slot="start"></ion-icon>
        Générer le diagramme
      </ion-button>
    </section>

    <!-- Overlay de chargement -->
    <div *ngIf="isGenerating || isExporting" class="loading-overlay">
      <ion-spinner name="crescent"></ion-spinner>
      <p>{{ isGenerating ? 'Génération du diagramme...' : 'Export en cours...' }}</p>
    </div>
  </main>

  <!-- settings button-->
  <app-floating-action-button
    icon="settings-outline"
    [position]="'top-right'"
    [offsetTop]="'145px'"
    [offsetRight]="'16px'"
    tooltip="Paramètres et contrôles du diagramme"
    [tooltipPosition]="'left'"
    (fabClick)="openControlPanel()">
  </app-floating-action-button>

  <!-- Données  -->
  <app-floating-action-button
    *ngIf="currentMermaidCode"
    icon="folder-open-outline"
    [position]="'top-right'"
    [offsetTop]="'190px'"
    [offsetRight]="'16px'"
    tooltip="Données du diagramme"
    [tooltipPosition]="'left'"
    (fabClick)="toggleDataPanel()">
  </app-floating-action-button>

  <!-- Bouton Mode Édition -->
  <app-floating-action-button
    *ngIf="currentMermaidCode"
    [icon]="isEditMode ? 'create' : 'create-outline'"
    [color]="isEditMode ? 'warning' : 'secondary'"
    [position]="'top-right'"
    [offsetTop]="'235px'"
    [offsetRight]="'16px'"
    [tooltip]="isEditMode ? 'Désactiver le mode édition' : 'Activer le mode édition (supprimer des relations)'"
    [tooltipPosition]="'left'"
    (fabClick)="toggleEditMode()">
  </app-floating-action-button>

  <!-- Bouton Mode Paradoxe -->
  <app-floating-action-button
    *ngIf="currentMermaidCode"
    [icon]="isParadoxMode ? 'warning' : 'warning-outline'"
    [color]="isParadoxMode ? 'danger' : 'secondary'"
    [position]="'top-right'"
    [offsetTop]="'280px'"
    [offsetRight]="'16px'"
    [tooltip]="isParadoxMode ? 'Désactiver la visualisation des paradoxes' : 'Visualiser les paradoxes'"
    [tooltipPosition]="'left'"
    (fabClick)="toggleParadoxMode()">
  </app-floating-action-button>

  <!-- Overlay de confirmation de suppression -->
  <div 
    *ngIf="showDeleteConfirmation" 
    class="delete-confirmation-overlay" 
    (click)="cancelDeleteConfirmation()">
  </div>

  <!-- Tooltip de confirmation de suppression -->
  <div 
    *ngIf="showDeleteConfirmation && pendingDeletionEvent" 
    class="delete-confirmation-tooltip"
    [ngStyle]="{
      'left.px': deleteConfirmationPosition.x,
      'top.px': deleteConfirmationPosition.y 
    }"
    (click)="$event.stopPropagation()">
    
    <div class="tooltip-header">
      <ion-icon name="trash-outline" color="danger"></ion-icon>
      <h4>Supprimer cette relation ? </h4>
    </div>
    
    <div class="tooltip-content">
      <div class="relation-info">
        <!-- Source -->
        <div class="entity source">
          <ion-icon 
            [name]="pendingDeletionEvent.resolvedRelation.edgeIdentifier.sourceType === 'us' ? 'layers-outline' : 'cube-outline'"
            [color]="pendingDeletionEvent. resolvedRelation. edgeIdentifier. sourceType === 'us' ? 'primary' : 'warning'">
          </ion-icon>
          <span>{{ getEntityLabel(
            pendingDeletionEvent.resolvedRelation.edgeIdentifier.sourceUuid,
            pendingDeletionEvent.resolvedRelation.edgeIdentifier.sourceType
          ) }}</span>
        </div>
        
        <!-- Flèche -->
        <ion-icon 
          [name]="pendingDeletionEvent. resolvedRelation. relation.is_contemporain ? 'swap-horizontal' : 'arrow-forward'" 
          class="arrow-icon">
        </ion-icon>
        
        <!-- Target -->
        <div class="entity target">
          <ion-icon 
            [name]="pendingDeletionEvent. resolvedRelation. edgeIdentifier.targetType === 'us' ? 'layers-outline' : 'cube-outline'"
            [color]="pendingDeletionEvent.resolvedRelation.edgeIdentifier.targetType === 'us' ?  'primary' :  'warning'">
          </ion-icon>
          <span>{{ getEntityLabel(
            pendingDeletionEvent.resolvedRelation.edgeIdentifier.targetUuid,
            pendingDeletionEvent.resolvedRelation.edgeIdentifier.targetType
          ) }}</span>
        </div>
      </div>
      
      <!-- Type de relation -->
      <div class="relation-type" *ngIf="pendingDeletionEvent.resolvedRelation.relation.is_contemporain">
        <ion-chip color="tertiary" size="small">
          <ion-icon name="git-compare-outline"></ion-icon>
          <ion-label>Contemporain</ion-label>
        </ion-chip>
      </div>
    </div>
    
    <div class="tooltip-actions">
      <ion-button 
        fill="outline" 
        size="small" 
        (click)="cancelDeleteConfirmation()"
        [disabled]="isDeletingRelation">
        Annuler
      </ion-button>
      <ion-button 
        color="danger" 
        size="small" 
        (click)="confirmDeleteRelation()"
        [disabled]="isDeletingRelation">
        <ion-spinner *ngIf="isDeletingRelation" name="crescent" slot="start"></ion-spinner>
        <ion-icon *ngIf="! isDeletingRelation" name="trash-outline" slot="start"></ion-icon>
        {{ isDeletingRelation ? 'Suppression.. .' : 'Supprimer' }}
      </ion-button>
    </div>
  </div>

  <!-- Panneau de contrôle -->
  <app-floating-panel
    [isOpen]="isControlPanelOpen"
    (isOpenChange)="isControlPanelOpen = $event"
    title="Contrôles du diagramme"
    [position]="'right'"
    [width]="'450px'"
    (closed)="onControlPanelClosed()">

    <div class="control-panel-content">
      <!-- Section Génération -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="git-network-outline"></ion-icon>
          Génération
        </h3>

        <ion-button
          expand="block"
          (click)="generateDiagram()"
          [disabled]="isGenerating"
          color="primary"
          class="ion-margin-bottom">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          {{ isGenerating ? 'Génération en cours...' : 'Générer le diagramme' }}
        </ion-button>

        <ion-item *ngIf="errorMessage" lines="none" color="danger" class="error-message">
          <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
          <ion-label class="ion-text-wrap">{{ errorMessage }}</ion-label>
        </ion-item>
      </div>

      <!-- ============= -->
      <!-- apparence     -->
      <!-- ============= -->
      <div class="control-section">
      <h3 class="section-title">
        <ion-icon name="color-palette-outline"></ion-icon>
        Apparence
      </h3>

      <!-- Accordéon pour les styles -->
      <ion-accordion-group [multiple]="false" class="style-accordion">
        
        <!-- Style US -->
        <ion-accordion value="us">
          <ion-item slot="header" lines="none" class="accordion-header">
            <div class="style-preview us-preview" 
                [style.background]="styleConfig.usBackground"
                [style.borderColor]="styleConfig.usStroke"></div>
            <ion-label>Unités Stratigraphiques</ion-label>
          </ion-item>
          <div slot="content" class="style-options">
            <div class="color-option">
              <label>Fond</label>
              <input type="color" 
                    [value]="styleConfig.usBackground" 
                    (input)="onStyleChange('usBackground', $event)">
            </div>
            <div class="color-option">
              <label>Bordure</label>
              <input type="color" 
                    [value]="styleConfig.usStroke" 
                    (input)="onStyleChange('usStroke', $event)">
            </div>
          </div>
        </ion-accordion>

        <!-- Style Faits -->
        <ion-accordion value="fait">
          <ion-item slot="header" lines="none" class="accordion-header">
            <div class="style-preview fait-preview"
                [style.background]="styleConfig.faitBackground"
                [style.borderColor]="styleConfig.faitStroke"></div>
            <ion-label>Faits</ion-label>
          </ion-item>
          <div slot="content" class="style-options">
            <div class="color-option">
              <label>Fond</label>
              <input type="color" 
                    [value]="styleConfig.faitBackground" 
                    (input)="onStyleChange('faitBackground', $event)">
            </div>
            <div class="color-option">
              <label>Bordure</label>
              <input type="color" 
                    [value]="styleConfig.faitStroke" 
                    (input)="onStyleChange('faitStroke', $event)">
            </div>
          </div>
        </ion-accordion>

        <!-- Style Groupes Contemporains -->
        <ion-accordion value="contemporary">
          <ion-item slot="header" lines="none" class="accordion-header">
            <div class="style-preview contemporary-preview"
                [style.background]="styleConfig.contemporaryGroupBackground"
                [style.borderColor]="styleConfig.contemporaryGroupStroke"></div>
            <ion-label>Groupes contemporains</ion-label>
          </ion-item>
          <div slot="content" class="style-options">
            <div class="color-option">
              <label>Fond</label>
              <input type="color" 
                    [value]="styleConfig.contemporaryGroupBackground" 
                    (input)="onStyleChange('contemporaryGroupBackground', $event)">
            </div>
            <div class="color-option">
              <label>Bordure</label>
              <input type="color" 
                    [value]="styleConfig.contemporaryGroupStroke" 
                    (input)="onStyleChange('contemporaryGroupStroke', $event)">
            </div>
          </div>
        </ion-accordion>
      </ion-accordion-group>

      <!-- Bouton réinitialiser -->
      <ion-button 
        expand="block" 
        fill="outline" 
        size="small" 
        (click)="resetStyles()"
        class="reset-styles-btn">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Réinitialiser les couleurs
      </ion-button>
    </div>
  


      <!-- =========== -->
      <!-- Mode Layout -->
      <!-- =========== -->

      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="grid-outline"></ion-icon>
          Mode d'affichage
        </h3>

        <ion-list class="layout-options-list">
          <ion-item
            *ngFor="let mode of layoutModes"
            (click)="selectLayoutMode(mode.value)"
            [class.selected]="currentLayoutMode === mode.value"
            class="layout-option-item"
            button
            lines="none">
            <ion-icon
              slot="start"
              [name]="mode.value === 'default' ? 'git-network-outline' :
                     mode.value === 'elk' ? 'apps-outline' : 'analytics-outline'"
              [color]="currentLayoutMode === mode.value ? 'primary' : 'medium'">
            </ion-icon>
            <ion-label>
              <h3>{{ mode.label }}</h3>
              <p>{{ mode.description }}</p>
            </ion-label>
            <ion-icon
              *ngIf="currentLayoutMode === mode.value"
              slot="end"
              name="checkmark-circle"
              color="primary">
            </ion-icon>
          </ion-item>
        </ion-list>
      </div>

      <!-- Section Export -->
      <div class="control-section" *ngIf="currentMermaidCode">
        <h3 class="section-title">
          <ion-icon name="download-outline"></ion-icon>
          Export
        </h3>

        <div class="button-grid">
          <ion-button
            expand="block"
            (click)="exportSVG()"
            [disabled]="isExporting"
            color="secondary"
            size="small">
            <ion-icon name="code-outline" slot="start"></ion-icon>
            SVG
          </ion-button>

          <ion-button
            expand="block"
            (click)="copyMermaidCode()"
            color="tertiary"
            size="small">
            <ion-icon name="copy-outline" slot="start"></ion-icon>
            Copier code
          </ion-button>
        </div>
      </div>

      <!-- Section Options d'affichage -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="eye-outline"></ion-icon>
          Options d'affichage
        </h3>

        <ion-list>
          <ion-item>
            <ion-label>Grouper les contemporains</ion-label>
            <ion-toggle
              [(ngModel)]="diagramConfig.groupContemporaries"
              (ionChange)="toggleConfigOption('groupContemporaries')">
            </ion-toggle>
          </ion-item>
        </ion-list>
      </div>

      <!-- Section Filtres -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="funnel-outline"></ion-icon>
          Filtres
        </h3>

        <ion-list>
          <ion-item>
            <ion-label position="stacked">Profondeur maximale</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="filterOptions.maxDepth"
              placeholder="Illimitée"
              min="1"
              max="10">
            </ion-input>
          </ion-item>

          <ion-item lines="none">
            <ion-label position="stacked">Nœud focal</ion-label>
            <div class="focus-node-input-wrapper">
              <ion-input
                [(ngModel)]="focusNodeSearchQuery"
                (ionInput)="onFocusNodeSearchChange($event)"
                (ionFocus)="onFocusNodeInputFocus()"
                (ionBlur)="onFocusNodeInputBlur()"
                placeholder="Rechercher par nom ou UUID..."
                class="focus-node-input">
              </ion-input>

              <ion-button
                *ngIf="filterOptions.focusNodeUuid"
                fill="clear"
                size="small"
                (click)="clearFocusNodeSelection()"
                class="clear-focus-button">
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-item>

          <!-- Liste de suggestions -->
          <div *ngIf="showFocusNodeSuggestions" class="focus-node-suggestions">
            <ion-list *ngIf="focusNodeSearchResults. length > 0">
              <ion-item
                *ngFor="let node of focusNodeSearchResults"
                (click)="selectFocusNode(node)"
                class="suggestion-item"
                button>
                <ion-icon
                  slot="start"
                  [name]="node.type === 'us' ? 'layers-outline' : 'cube-outline'"
                  [color]="node.type === 'us' ? 'primary' : 'warning'">
                </ion-icon>
                <ion-label>
                  <h3>{{ node.label }}</h3>
                </ion-label>
              </ion-item>
            </ion-list>

            <div *ngIf="focusNodeSearchResults.length === 0 && focusNodeSearchQuery" class="no-suggestions">
              <ion-icon name="search-outline"></ion-icon>
              <p>Aucune entité trouvée pour "{{ focusNodeSearchQuery }}"</p>
            </div>

            <div *ngIf="allNodes.length === 0" class="no-data-suggestions">
              <ion-icon name="alert-circle-outline"></ion-icon>
              <p>Générez d'abord un diagramme</p>
            </div>
          </div>
        </ion-list>

        <div class="button-grid ion-margin-top">
          <ion-button
            expand="block"
            (click)="applyDepthFilter()"
            [disabled]="!currentMermaidCode"
            size="small">
            <ion-icon name="filter-outline" slot="start"></ion-icon>
            Appliquer
          </ion-button>

          <ion-button
            expand="block"
            fill="outline"
            (click)="clearFilters()"
            [disabled]="!hasActiveFilters"
            size="small">
            <ion-icon name="close-circle-outline" slot="start"></ion-icon>
            Effacer
          </ion-button>
        </div>

        <ion-chip *ngIf="hasActiveFilters" color="primary" class="ion-margin-top">
          <ion-icon name="funnel-outline"></ion-icon>
          <ion-label>Filtres actifs</ion-label>
        </ion-chip>
      </div>
    </div>
  </app-floating-panel>

  <!-- Panneau des Données -->
   <app-data-panel
    [isOpen]="isDataPanelOpen"
    (isOpenChange)="isDataPanelOpen = $event"
    [allNodes]="allNodes"
    [stats]="stats"
    (entityZoom)="zoomToEntity($event)"
    (diagramRegenerate)="generateDiagram()"
    (closed)="onDataPanelClosed()">
  </app-data-panel>

  <!-- Panneau des Cycles -->
  <app-paradoxes-panel
    [isOpen]="isParadoxesPanelOpen"
    (isOpenChange)="isParadoxesPanelOpen = $event"
    (closed)="onParadoxesPanelClosed()">
  </app-paradoxes-panel>
</div>
