<div id="container" class="stratigraphic-diagram-page">
  <!-- Zone de visualisation du diagramme - plein écran -->
  <main class="diagram-fullscreen">
    <!-- Diagramme -->
    <section class="diagram-display" [hidden]="!currentMermaidCode">
      <div
        #diagramContainer
        id="diagram-container"
        class="diagram-container">
        <!-- Le diagramme Mermaid sera rendu ici -->
      </div>

      <!-- Contrôles de zoom intégrés -->
      <div class="zoom-controls-overlay">
        <ion-button size="small" fill="solid" (click)="zoomIn()" color="light">
          <ion-icon name="add-circle-outline"></ion-icon>
        </ion-button>
        <ion-button size="small" fill="solid" (click)="zoomOut()" color="light">
          <ion-icon name="remove-circle-outline"></ion-icon>
        </ion-button>
        <ion-button size="small" fill="solid" (click)="centerDiagram()" color="light">
          <ion-icon name="locate-outline"></ion-icon>
        </ion-button>
        <ion-button size="small" fill="solid" (click)="toggleFullscreen()" color="light">
          <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'"></ion-icon>
        </ion-button>
      </div>
    </section>

    <!-- Message si pas de diagramme -->
    <section *ngIf="!currentMermaidCode && !isGenerating" class="empty-state">
      <ion-icon name="git-network-outline" class="empty-icon"></ion-icon>
      <h2>Aucun diagramme généré</h2>
      <p>Ouvrez le panneau de contrôle pour générer votre diagramme</p>
      <ion-button (click)="openControlPanel()" color="primary">
        <ion-icon name="settings-outline" slot="start"></ion-icon>
        Ouvrir les contrôles
      </ion-button>
    </section>

    <!-- Overlay de chargement -->
    <div *ngIf="isGenerating || isExporting" class="loading-overlay">
      <ion-spinner name="crescent"></ion-spinner>
      <p>{{ isGenerating ? 'Génération du diagramme...' : 'Export en cours...' }}</p>
    </div>
  </main>

  <!-- settings button-->
  <app-floating-action-button
    icon="settings-outline"
    [position]="'top-right'"
    [offsetTop]="'145px'"
    [offsetRight]="'16px'"
    (fabClick)="openControlPanel()">
  </app-floating-action-button>

  <!-- Mode de layout -->
  <app-floating-action-button
    icon="grid-outline"
    [position]="'top-right'"
    [offsetTop]="'190px'"
    [offsetRight]="'16px'"
    (fabClick)="toggleLayoutPanel()">
  </app-floating-action-button>

  <app-floating-action-button
    *ngIf="currentMermaidCode"
    icon="stats-chart-outline"
    [position]="'top-right'"
    [offsetTop]="'235px'"
    [offsetRight]="'16px'"
    (fabClick)="toggleStatsPanel()">
  </app-floating-action-button>

  <!-- Recherche d'entités -->
  <app-floating-action-button
    *ngIf="currentMermaidCode"
    icon="search-outline"
    [position]="'top-right'"
    [offsetTop]="'280px'"
    [offsetRight]="'16px'"
    (fabClick)="toggleSearchPanel()">
  </app-floating-action-button>




  <!-- Panneau de contrôle -->
  <app-floating-panel
    [isOpen]="isControlPanelOpen"
    (isOpenChange)="isControlPanelOpen = $event"
    title="Contrôles du diagramme"
    [position]="'right'"
    [width]="'450px'"
    (closed)="onControlPanelClosed()">

    <div class="control-panel-content">
      <!-- Section Génération -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="git-network-outline"></ion-icon>
          Génération
        </h3>

        <ion-button
          expand="block"
          (click)="generateDiagram()"
          [disabled]="isGenerating"
          color="primary"
          class="ion-margin-bottom">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          {{ isGenerating ? 'Génération en cours...' : 'Générer le diagramme' }}
        </ion-button>

        <ion-item *ngIf="errorMessage" lines="none" color="danger" class="error-message">
          <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
          <ion-label class="ion-text-wrap">{{ errorMessage }}</ion-label>
        </ion-item>
      </div>

      <!-- Section Export -->
      <div class="control-section" *ngIf="currentMermaidCode">
        <h3 class="section-title">
          <ion-icon name="download-outline"></ion-icon>
          Export
        </h3>

        <div class="button-grid">
          <ion-button
            expand="block"
            (click)="exportPNG()"
            [disabled]="isExporting"
            color="secondary"
            size="small">
            <ion-icon name="image-outline" slot="start"></ion-icon>
            PNG
          </ion-button>

          <ion-button
            expand="block"
            (click)="exportPDF()"
            [disabled]="isExporting"
            color="secondary"
            size="small">
            <ion-icon name="document-outline" slot="start"></ion-icon>
            PDF
          </ion-button>

          <ion-button
            expand="block"
            (click)="copyMermaidCode()"
            color="tertiary"
            size="small">
            <ion-icon name="copy-outline" slot="start"></ion-icon>
            Copier code
          </ion-button>
        </div>
      </div>

      <!-- Section Options d'affichage -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="eye-outline"></ion-icon>
          Options d'affichage
        </h3>

        <ion-list>

          <ion-item>
            <ion-label>Mettre en évidence les cycles</ion-label>
            <ion-toggle
              [(ngModel)]="diagramConfig.highlightCycles"
              (ionChange)="toggleConfigOption('highlightCycles')">
            </ion-toggle>
          </ion-item>

          <ion-item>
            <ion-label>Grouper les contemporains</ion-label>
            <ion-toggle
              [(ngModel)]="diagramConfig.groupContemporaries"
              (ionChange)="toggleConfigOption('groupContemporaries')">
            </ion-toggle>
          </ion-item>
        </ion-list>
      </div>

      <!-- Section Filtres -->
      <div class="control-section">
        <h3 class="section-title">
          <ion-icon name="funnel-outline"></ion-icon>
          Filtres
        </h3>

        <ion-list>
          <ion-item>
            <ion-label position="stacked">Profondeur maximale</ion-label>
            <ion-input
              type="number"
              [(ngModel)]="filterOptions.maxDepth"
              placeholder="Illimitée"
              min="1"
              max="10">
            </ion-input>
          </ion-item>

          <ion-item lines="none">
            <ion-label position="stacked">Nœud focal</ion-label>
            <div class="focus-node-input-wrapper">
              <ion-input
                [(ngModel)]="focusNodeSearchQuery"
                (ionInput)="onFocusNodeSearchChange($event)"
                (ionFocus)="onFocusNodeInputFocus()"
                (ionBlur)="onFocusNodeInputBlur()"
                placeholder="Rechercher par nom ou UUID..."
                class="focus-node-input">
              </ion-input>

              <ion-button
                *ngIf="filterOptions.focusNodeUuid"
                fill="clear"
                size="small"
                (click)="clearFocusNodeSelection()"
                class="clear-focus-button">
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-item>

          <!-- Liste de suggestions -->
          <div *ngIf="showFocusNodeSuggestions" class="focus-node-suggestions">
            <ion-list *ngIf="focusNodeSearchResults. length > 0">
              <ion-item
                *ngFor="let node of focusNodeSearchResults"
                (click)="selectFocusNode(node)"
                class="suggestion-item"
                button>
                <ion-icon
                  slot="start"
                  [name]="node.type === 'us' ? 'layers-outline' : 'cube-outline'"
                  [color]="node.type === 'us' ? 'primary' : 'warning'">
                </ion-icon>
                <ion-label>
                  <h3>{{ node.label }}</h3>
                  <p class="entity-type">{{ node.type === 'us' ? 'Unité Stratigraphique' : 'Fait' }}</p>
                  <p class="entity-uuid">{{ node.uuid }}</p>
                </ion-label>
              </ion-item>
            </ion-list>

            <div *ngIf="focusNodeSearchResults.length === 0 && focusNodeSearchQuery" class="no-suggestions">
              <ion-icon name="search-outline"></ion-icon>
              <p>Aucune entité trouvée pour "{{ focusNodeSearchQuery }}"</p>
            </div>

            <div *ngIf="allNodes.length === 0" class="no-data-suggestions">
              <ion-icon name="alert-circle-outline"></ion-icon>
              <p>Générez d'abord un diagramme</p>
            </div>
          </div>
        </ion-list>

        <div class="button-grid ion-margin-top">
          <ion-button
            expand="block"
            (click)="applyDepthFilter()"
            [disabled]="!currentMermaidCode"
            size="small">
            <ion-icon name="filter-outline" slot="start"></ion-icon>
            Appliquer
          </ion-button>

          <ion-button
            expand="block"
            fill="outline"
            (click)="clearFilters()"
            [disabled]="!hasActiveFilters"
            size="small">
            <ion-icon name="close-circle-outline" slot="start"></ion-icon>
            Effacer
          </ion-button>
        </div>

        <ion-chip *ngIf="hasActiveFilters" color="primary" class="ion-margin-top">
          <ion-icon name="funnel-outline"></ion-icon>
          <ion-label>Filtres actifs</ion-label>
        </ion-chip>
      </div>
    </div>
  </app-floating-panel>

  <!-- Panneau Statistiques -->
  <app-floating-panel
    [isOpen]="isStatsPanelOpen"
    (isOpenChange)="isStatsPanelOpen = $event"
    title="Statistiques du diagramme"
    [position]="'right'"
    [width]="'350px'"
    (closed)="onStatsPanelClosed()">

    <div class="stats-panel-content" *ngIf="currentMermaidCode">
      <ion-grid>
        <ion-row>
          <ion-col size="6">
            <div class="stat-card">
              <div class="stat-value">{{ stats.totalNodes }}</div>
              <div class="stat-label">Nœuds</div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-card">
              <div class="stat-value">{{ stats.totalEdges }}</div>
              <div class="stat-label">Relations</div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-card">
              <div class="stat-value">{{ stats.usCount }}</div>
              <div class="stat-label">US</div>
            </div>
          </ion-col>
          <ion-col size="6">
            <div class="stat-card">
              <div class="stat-value">{{ stats.faitCount }}</div>
              <div class="stat-label">Faits</div>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
  </app-floating-panel>

  <!-- Recherche d'entités -->
  <app-floating-panel
    [isOpen]="isSearchPanelOpen"
    (isOpenChange)="isSearchPanelOpen = $event"
    title="Rechercher une entité"
    [position]="'right'"
    [width]="'400px'"
    (closed)="onSearchPanelClosed()">

    <div class="search-panel-content">
      <!-- Barre de recherche -->
      <div class="search-input-container">
        <ion-searchbar
          [(ngModel)]="searchQuery"
          (ionInput)="onSearchQueryChange()"
          placeholder="Rechercher par nom ou UUID..."
          [debounce]="300"
          showCancelButton="never">
        </ion-searchbar>
      </div>

      <!-- Résultats de recherche -->
      <div class="search-results">
        <ion-list *ngIf="searchResults.length > 0">
          <ion-item
            *ngFor="let node of searchResults"
            (click)="zoomToEntity(node)"
            class="search-result-item">
            <ion-icon
              slot="start"
              [name]="node.type === 'us' ? 'layers-outline' : 'cube-outline'"
              [color]="node.type === 'us' ? 'primary' : 'warning'">
            </ion-icon>
            <ion-label>
              <h3>{{ node.label }}</h3>
              <p class="entity-type">{{ node.type === 'us' ? 'Unité Stratigraphique' : 'Fait' }}</p>
              <p class="entity-uuid">{{ node.uuid }}</p>
            </ion-label>
            <ion-icon slot="end" name="locate-outline" color="medium"></ion-icon>
          </ion-item>
        </ion-list>

        <div *ngIf="searchResults.length === 0 && searchQuery" class="no-results">
          <ion-icon name="search-outline"></ion-icon>
          <p>Aucune entité trouvée pour "{{ searchQuery }}"</p>
        </div>

        <div *ngIf="allNodes.length === 0" class="no-data">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>Générez d'abord un diagramme pour rechercher des entités</p>
        </div>
      </div>
    </div>
  </app-floating-panel>

  <!--Mode de layout -->
  <app-floating-panel
    [isOpen]="isLayoutPanelOpen"
    (isOpenChange)="isLayoutPanelOpen = $event"
    title="Mode d'affichage"
    [position]="'right'"
    [width]="'380px'"
    (closed)="onLayoutPanelClosed()">

    <div class="layout-panel-content">
      <p class="layout-description">
        Choisissez l'algorithme de disposition du diagramme
      </p>

      <ion-list>
        <ion-item
          *ngFor="let mode of layoutModes"
          (click)="selectLayoutMode(mode.value)"
          [class.selected]="currentLayoutMode === mode.value"
          class="layout-option">
          <ion-icon
            slot="start"
            [name]="mode.value === 'default' ? 'git-network-outline' :
                   mode.value === 'elk' ? 'apps-outline' : 'analytics-outline'"
            [color]="currentLayoutMode === mode.value ? 'primary' : 'medium'">
          </ion-icon>
          <ion-label>
            <h3>{{ mode.label }}</h3>
            <p>{{ mode.description }}</p>
          </ion-label>
          <ion-icon
            *ngIf="currentLayoutMode === mode.value"
            slot="end"
            name="checkmark-circle"
            color="primary">
          </ion-icon>
        </ion-item>
      </ion-list>
    </div>
  </app-floating-panel>
</div>
