<app-floating-panel
  [isOpen]="isOpen"
  (isOpenChange)="isOpenChange. emit($event)"
  title="Cycles détectés (Paradoxes)"
  [position]="'right'"
  [width]="'450px'"
  [showBackdrop]="false"
  [allowBackgroundInteractions]="true"
  (closed)="close()">

  <div class="cycles-panel-content">

    <!-- Barre d'outils -->
    <div class="toolbar" *ngIf="cycles. length > 0">
      <!-- Navigation -->
      <div class="navigation-controls">
        <ion-button
          size="small"
          fill="outline"
          (click)="previousCycle()"
          [disabled]="cycles.length <= 1 || multiSelectMode">
          <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
        </ion-button>

        <span class="nav-indicator">
          {{ navigationState.currentIndex + 1 }} / {{ navigationState.totalCycles }}
        </span>

        <ion-button
          size="small"
          fill="outline"
          (click)="nextCycle()"
          [disabled]="cycles.length <= 1 || multiSelectMode">
          <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <!-- Mode sélection -->
      <div class="selection-controls">
        <ion-button
          size="small"
          [fill]="multiSelectMode ? 'solid' : 'outline'"
          [color]="multiSelectMode ? 'primary' : 'medium'"
          (click)="toggleMultiSelectMode()">
          <ion-icon name="checkbox-outline" slot="start"></ion-icon>
          Multi
        </ion-button>

        <ion-button
          *ngIf="multiSelectMode"
          size="small"
          fill="clear"
          (click)="selectAll()">
          Tout
        </ion-button>

        <ion-button
          *ngIf="multiSelectMode && selectedCount > 0"
          size="small"
          fill="clear"
          color="medium"
          (click)="deselectAll()">
          Aucun
        </ion-button>
      </div>
    </div>

    <!-- Résumé -->
    <div class="cycles-summary" *ngIf="cycles.length > 0">
      <div class="summary-icon">
        <ion-icon name="warning-outline" color="danger"></ion-icon>
      </div>
      <div class="summary-text">
        <strong>{{ cycles.length }}</strong> cycle(s) détecté(s)
        <span *ngIf="multiSelectMode && selectedCount > 0">
          • {{ selectedCount }} sélectionné(s)
        </span>
      </div>
    </div>

    <!-- Liste des cycles -->
    <div class="cycles-list" *ngIf="cycles.length > 0">
      <ion-list>
        <ion-item
          *ngFor="let cycle of cycles; let i = index"
          (click)="onCycleClick(cycle, i, $event)"
          class="cycle-item"
          [class.selected]="isCycleSelected(cycle.cycleId)"
          [class.current]="isCurrentCycle(i) && !multiSelectMode"
          [style.--cycle-color]="getCycleColor(i)"
          [style.--cycle-bg-color]="getCycleBackgroundColor(i)"
          [style.border-left]="isCycleSelected(cycle.cycleId) ? '6px solid ' + getCycleColor(i) : 'none'"
          button
          detail="false">

          <!-- Icône cycle -->
          <ion-icon
            slot="start"
            name="sync-circle-outline"
            [style.color]="isCycleSelected(cycle.cycleId) ? getCycleColor(i) : null"
            [class.rotating]="isCurrentCycle(i) && !multiSelectMode">
          </ion-icon>

          <!-- Contenu -->
          <ion-label>
            <h3 [style.color]="isCycleSelected(cycle.cycleId) ? getCycleColor(i) : null">
              {{ getCycleTitle(i) }}
            </h3>
            <div class="cycle-nodes-preview">
              <ion-chip
                *ngFor="let node of getDisplayNodes(cycle)"
                size="small"
                [style.--background]="isCycleSelected(cycle.cycleId) ? getCycleChipColor(i) : null"
                [style.--color]="isCycleSelected(cycle. cycleId) ? getCycleColor(i) : null">
                {{ node }}
              </ion-chip>
            </div>
          </ion-label>

          <!-- Indicateur de visibilité -->
          <ion-icon
            slot="end"
            [name]="isCycleSelected(cycle.cycleId) ? 'eye' : 'eye-off-outline'"
            [style.color]="isCycleSelected(cycle.cycleId) ? getCycleColor(i) : null">
          </ion-icon>
        </ion-item>
      </ion-list>
    </div>

    

    <!-- État vide - aucun cycle -->
    <div class="no-cycles" *ngIf="cycles. length === 0">
      <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
      <h3>Aucun cycle détecté</h3>
      <p>Votre diagramme stratigraphique ne contient pas de paradoxes de type cycle.</p>
    </div>
  </div>
</app-floating-panel>