<ion-card *ngIf="project.item" style="height: 100%">
  <ion-card-header>
    <h3 style="color: black">
      <app-castor-tooltip>
        <h3 style="color: black"><strong>{{ project.item?.commune ?? 'Commune'}}</strong> -
          <i>{{ project.item?.lieu_dit ?? 'Lieu dit' }}</i>
        </h3>
      </app-castor-tooltip>
      <strong>
        <ion-icon *ngIf="project.item?.write_lock_enabled" name="lock-closed-outline" class="lock-icon"></ion-icon>
        {{ project.item?.projet_label}}
      </strong>
    </h3>
  </ion-card-header>
  <ion-card-content>
    <ion-row>
      <ion-col>
        <ion-label>
          <ng-container *ngIf="isIndexed; else notIndexed">
            <ng-container *ngIf="!project_loading;else indexRunning">
              <ng-container *ngIf="items > 0;else emptyProject">
                {{this.itemsInStore}}  /  {{this.items}}
              </ng-container>
              <ng-template #emptyProject>
                Projet vide
              </ng-template>
              <ion-note>
                ({{ this.index?.last_updated ? (this.index?.last_updated | date: 'short') : '-' }})
              </ion-note>
            </ng-container>
            <ng-template #indexRunning>
              Chargement en cours
            </ng-template>
          </ng-container>
          <ng-template #notIndexed>
            Non indéxé
          </ng-template>
        </ion-label>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="12">
        Année : {{ project.item?.projet_years ?? 'Non renseigné'}}
      </ion-col>
      <ion-col size="12">
        Responsable : {{ project.item ? (project.item | apiProjectOwner) : 'Non renseigné' }}
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <img src="assets/images/archeo.webp">
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="12">
        <ng-container *ngIf="!isIndexed; else IndexedButton">
          <app-access-guard
            [project]="project.item"
            [onlineOnly]="true"
          >
            <ion-button expand="block"
                        [disabled]="project_loading"
                        (click)="onLoadProjet()">Charger
            </ion-button>
          </app-access-guard>

        </ng-container>
      </ion-col>
      <ion-col size="12">
        <app-access-guard
          [ownerOnly]="true"
          [project]="project.item"
          [onlineOnly]="true"
        >
          <ion-button expand="block" [disabled]="project_opening"
                      (click)="onConfigProjet(project.item?.projet_uuid)">Configurer
          </ion-button>
        </app-access-guard>
      </ion-col>
      <ion-col size="12">
        <app-access-guard
          [ownerOnly]="true"
          [project]="project.item"
          [onlineOnly]="true"
        >
          <ion-button expand="block" (click)="onEditProjet()">Modifier</ion-button>
        </app-access-guard>
      </ion-col>
      <ion-col size="12">
        <app-access-guard
          [ownerOnly]="true"
          [project]="project.item"
          [onlineOnly]="true"
        >
          <ion-button expand="block"
                      (click)="onDuplicateProjet()"
                      [disabled]="project_duplicating">
            <ion-spinner *ngIf="project_duplicating" slot="start"></ion-spinner>
            Dupliquer
          </ion-button>
        </app-access-guard>
      </ion-col>
      <ion-col size="12">
        <ion-button expand="block" *ngIf="this.isIndexed" (click)="onClearIndex()">
          Vider le cache
        </ion-button>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col>
        <ion-progress-bar type="indeterminate" *ngIf="this.project_loading || this.project_duplicating"></ion-progress-bar>
      </ion-col>
    </ion-row>
  </ion-card-content>
</ion-card>

<ng-template #IndexedButton>
  <app-access-guard
    [project]="project.item"
  >
    <ion-button expand="block" [disabled]="project_opening"
                                 (click)="onViewProject(project.item?.projet_uuid)">Ouvrir
    </ion-button>
    <ion-progress-bar type="indeterminate" *ngIf="this.project_opening"></ion-progress-bar>
  </app-access-guard>
</ng-template>
